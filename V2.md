# MCP Email Server V2 Plan

## User Stories

### 1. Email Management
- As a user, I want to read all emails in a thread to have complete context
- [x] As a user, I want to paginate through results when I have many emails
- As a user, I want to mark emails as read/unread
- As a user, I want to archive emails
- As a user, I want to delete emails (move to trash)
- As a user, I want to search only in Primary category or Starred by default

### 2. Composition and Response
- As a user, I want to Reply while maintaining thread context
- As a user, I want to Reply All with all original recipients
- As a user, I want to Forward with attachments
- As a user, I want to save drafts
- As a user, I want to attach files to new emails or replies

### 3. Viewing and Processing
- As a user, I want to view HTML formatted emails in an easy-to-read way
- As a user, I want to extract text from HTML emails for processing
- As a user, I want to download and manage attachments

## Gmail API Analysis

### Available Features
1. Pagination:
   - [x] Support for `pageToken` in listings
   - [x] Maximum 500 results per page
   - [x] Token for next page

2. Labels and Categories:
   - [x] Primary, Social, Promotions, Updates, Forums
   - Filtering by labelIds
   - Modifying labels on messages

3. Thread Management:
   - Complete list of messages in thread
   - Thread metadata information
   - Operations on threads

4. Draft Management:
   - Create/Save drafts
   - Update drafts
   - Send draft

## Implementation Plan

### 1. Infrastructure Improvements (Priority: HIGH)
- [x] 1.1. Implement results pagination
- [x] 1.1.1. Add automatic pagination capability with autoFetchAll parameter
- [ ] 1.2. Support for label management
- [ ] 1.3. Improve thread caching
- [ ] 1.4. Improved logging system

### 2. New Email Tools (Priority: HIGH)
- [ ] 2.1. Tool for Reply All
- [ ] 2.2. Tool for Forward
- [ ] 2.3. Tool for draft management
- [ ] 2.4. Tool for attachment management
- [ ] 2.5. Tool for HTML to text processing
- [ ] 2.6. Tool for marking email as read/unread
- [ ] 2.7. Tool for email archiving
- [ ] 2.8. Tool for email deletion

### 3. Existing Improvements (Priority: MEDIUM)
- [x] 3.1. Add support for categories in search
- [x] 3.1.1. Improve category vs. label documentation and clarity
- [x] 3.1.2. Add timestamp information to search results
- [ ] 3.2. Improve thread context extraction
- [ ] 3.3. Optimize cache for quick responses
- [ ] 3.4. Enhanced input validations

### 4. New Prompts (Priority: MEDIUM)
- [ ] 4.1. Prompt for Reply All
- [ ] 4.2. Prompt for Forward
- [ ] 4.3. Prompt for draft management
- [ ] 4.4. Prompt for HTML processing

### 5. Documentation and Testing (Priority: LOW)
- [x] 5.1. Documentation for new features
- [x] 5.2. Usage examples for each tool
- [ ] 5.3. Test suite for new features
- [ ] 5.4. Migration guide from V1

## Technical Implementation

### 1. Pagination
```typescript
interface PaginationOptions {
  pageSize?: number;  // default 25, max 500
  pageToken?: string;
  labelIds?: string[];
  includeSpamTrash?: boolean;
  query?: string;
  autoFetchAll?: boolean; // Auto-fetch all results (up to limit)
  maxAutoFetchResults?: number; // Maximum results with autoFetchAll
}

interface PaginatedResponse<T> {
  items: T[];
  nextPageToken?: string;
  resultSizeEstimate: number;
}
```

### 2. Thread Management
```typescript
interface ThreadOptions {
  includeFullContext?: boolean;
  extractPlainText?: boolean;
  markAsRead?: boolean;
}

interface ThreadResponse {
  threadId: string;
  messages: EmailMessage[];
  participants: string[];
  subject: string;
  snippet: string;
  labels: string[];
}
```

### 3. Draft Management
```typescript
interface DraftOptions {
  to: string[];
  subject: string;
  content: string;
  attachments?: Attachment[];
  cc?: string[];
  bcc?: string[];
  inReplyTo?: string;
  references?: string[];
}

interface Draft {
  id: string;
  message: EmailMessage;
  updated: string;
}
```

## New Tools

### 1. Email Processing
```typescript
const emailProcessingTools = {
  convertHtmlToText: async (html: string): Promise<string> => {
    // Implementation of HTML to plain text conversion
  },
  
  extractImagesFromHtml: async (html: string): Promise<Attachment[]> => {
    // Extract images from HTML
  },
  
  parseEmailAddresses: (addresses: string): EmailAddress[] => {
    // Parse email addresses from string
  }
};
```

### 2. Attachment Management
```typescript
const attachmentTools = {
  uploadAttachment: async (file: Buffer, metadata: AttachmentMetadata): Promise<string> => {
    // Upload attachment
  },
  
  downloadAttachment: async (attachmentId: string): Promise<Buffer> => {
    // Download attachment
  }
};
```

## Implementation Notes

#### Date Filtering Improvements
- [x] Added new `timeFilter` parameter to distinguish between calendar dates and time windows
- [x] Implemented support for "today", "yesterday", and "last24h" time filters
- [x] Modified responses to include clear time descriptions with actual dates
- [x] Added automatic conversion of `is:unread` to `label:unread` for better search results

#### Search Enhancement 
- [x] Improved templates with common search patterns and examples
- [x] Enhanced support for Gmail categories in search
- [x] Added better handling of combined filters (date + category + unread)
- [x] Default search now uses today's calendar date instead of rolling 24-hour window
- [x] Added timestamp information to search results

#### Documentation 
- [x] Updated prompt templates with clear examples for common use cases
- [x] Added detailed error messages for better understanding of search results
- [x] Improved parameter descriptions
- [x] Enhanced clarity on the distinction between categories and labels

## Follow-up Tasks
- Implement a proper test suite for search functionality with various combinations of filters
- Add tools for directly managing email labels (marking read/unread, archiving, deleting)
- Improve code organization with more consistent error handling patterns
- Enhance documentation with examples for complex search queries and category filtering
- Add functionality to retrieve and display all messages in a thread
- Implement tools for email organization (archive, delete, move to folder)
- Add support for HTML email rendering and formatting in responses
- Create a tool for attachment download and management
- Implement error recovery mechanisms for authentication and API rate limiting
- Develop a retry mechanism for failed API requests

