# MCP Email Server V2 Plan

## User Stories

### 1. Email Management
- As a user, I want to read all emails in a thread to have complete context
- As a user, I want to paginate through results when I have many emails
- As a user, I want to mark emails as read/unread
- As a user, I want to archive emails
- As a user, I want to delete emails (move to trash)
- As a user, I want to search only in Primary category or Starred by default

### 2. Composition and Response
- As a user, I want to Reply while maintaining thread context
- As a user, I want to Reply All with all original recipients
- As a user, I want to Forward with attachments
- As a user, I want to save drafts
- As a user, I want to attach files to new emails or replies

### 3. Viewing and Processing
- As a user, I want to view HTML formatted emails in an easy-to-read way
- As a user, I want to extract text from HTML emails for processing
- As a user, I want to download and manage attachments

## Gmail API Analysis

### Available Features
1. Pagination:
   - Support for `pageToken` in listings
   - Maximum 500 results per page
   - Token for next page

2. Labels and Categories:
   - Primary, Social, Promotions, Updates, Forums
   - Filtering by labelIds
   - Modifying labels on messages

3. Thread Management:
   - Complete list of messages in thread
   - Thread metadata information
   - Operations on threads

4. Draft Management:
   - Create/Save drafts
   - Update drafts
   - Send draft

## Gmail Provider Features

### Email Operations
- [x] Read emails with full content extraction (text and HTML)
- [x] Extract attachments from emails
- [x] Send emails with CC, BCC
- [x] Reply to emails (including proper threading)
- [x] Support for drafts
- [x] Support for label management (create, modify, delete labels, add/remove labels from messages)
- [x] Support for time zone configuration to display and query emails in the user's local time

### Search and Filter
- [x] Add support for categories in search
- [x] Add timestamp information to all email results
- [x] Increase default result limit from 10 to 25 emails
- [x] Improve pagination messaging with better guidance
- [x] Enhance documentation on category vs label distinctions
- [ ] Improve thread context extraction
- [ ] Optimize cache for quick responses
- [ ] Enhanced input validations

## Implementation Plan

### 1. Infrastructure Improvements (Priority: HIGH)
- [x] 1.1. Implement results pagination
- [x] 1.1.1. Implement automatic pagination with autoFetchAll parameter
- [x] 1.2. Support for label management
- [x] 1.3. Support for timezone configuration
- [x] 1.4. Improve thread caching
- [x] 1.5. Improved logging system

### 2. New Email Tools (Priority: HIGH)
- [x] 2.1. Tool for Reply All
- [x] 2.2. Tool for Forward
- [x] 2.3. Tool for draft management
- [x] 2.4. Tool for attachment management
- [X] 2.5. Tool for HTML to text processing
- [x] 2.6. Tool for marking email as read/unread
- [x] 2.7. Tool for email archiving
- [x] 2.8. Tool for email deletion

### 3. Existing Improvements (Priority: MEDIUM)
- [x] 3.1. Add support for categories in search
- [x] 3.2. Add timestamp information to all email results
- [x] 3.3. Increase default result limit from 10 to 25 emails
- [x] 3.4. Improve pagination messaging with better guidance
- [x] 3.5. Enhance documentation on category vs label distinctions
- [X] 3.6. Improve thread context extraction
- [X] 3.7. Optimize cache for quick responses
- [X] 3.8. Enhanced input validations

### 5. Documentation and Testing (Priority: LOW)
- Documentation for new features
- Usage examples for each tool
- Test suite for new features
- Migration guide from V1

## Technical Implementation

### 1. Pagination
```typescript
interface PaginationOptions {
  pageSize?: number;  // default 100, max 500
  pageToken?: string;
  labelIds?: string[];
  includeSpamTrash?: boolean;
  query?: string;
}

interface PaginatedResponse<T> {
  items: T[];
  nextPageToken?: string;
  resultSizeEstimate: number;
}
```

### 2. Thread Management
```typescript
interface ThreadOptions {
  includeFullContext?: boolean;
  extractPlainText?: boolean;
  markAsRead?: boolean;
}

interface ThreadResponse {
  threadId: string;
  messages: EmailMessage[];
  participants: string[];
  subject: string;
  snippet: string;
  labels: string[];
}
```

### 3. Draft Management
```typescript
interface DraftOptions {
  to: string[];
  subject: string;
  content: string;
  attachments?: Attachment[];
  cc?: string[];
  bcc?: string[];
  inReplyTo?: string;
  references?: string[];
}

interface Draft {
  id: string;
  message: EmailMessage;
  updated: string;
}
```

## New Tools

### 1. Email Processing
```typescript
const emailProcessingTools = {
  convertHtmlToText: async (html: string): Promise<string> => {
    // Implementation of HTML to plain text conversion
  },
  
  extractImagesFromHtml: async (html: string): Promise<Attachment[]> => {
    // Extract images from HTML
  },
  
  parseEmailAddresses: (addresses: string): EmailAddress[] => {
    // Parse email addresses from string
  }
};
```

### 2. Attachment Management
```typescript
const attachmentTools = {
  uploadAttachment: async (file: Buffer, metadata: AttachmentMetadata): Promise<string> => {
    // Upload attachment
  },
  
  downloadAttachment: async (attachmentId: string): Promise<Buffer> => {
    // Download attachment
  }
};
```

## Implementation Notes

#### Date Filtering Improvements
- Added new `timeFilter` parameter to distinguish between calendar dates and time windows
- Implemented support for "today", "yesterday", and "last24h" time filters
- Modified responses to include clear time descriptions with actual dates
- Added automatic conversion of `is:unread` to `label:unread` for better search results

#### Search Enhancement 
- Improved templates with common search patterns and examples
- Enhanced support for Gmail categories in search
- Added better handling of combined filters (date + category + unread)
- Default search now uses today's calendar date instead of rolling 24-hour window

#### Documentation 
- Updated prompt templates with clear examples for common use cases
- Added detailed error messages for better understanding of search results
- Improved parameter descriptions

## Follow-up Tasks
- Implement a proper test suite for search functionality with various combinations of filters
- Enhance documentation with examples for complex search queries and category filtering
- Implement stress testing for the automatic pagination functionality
- Add support for email importance flagging (mark as important/not important)
- Optimize timestamp parsing for better performance with large result sets
- Create more comprehensive examples of how to use autoFetchAll with various search filters
- Develop additional label management features such as color customization and nested labels
- Create usage examples for label management in common email workflows
- Add batch operations for label management (applying same label to multiple messages)
- Implement tools for managing label visibility (show/hide in label list)
- Add support for additional timezone formats (e.g., IANA timezone names like 'Europe/Bucharest')
- Implement DST (Daylight Saving Time) awareness in timezone handling
- Improve timezone handling for date range searches (ensure consistency across timezone changes)
- Add timezone testing with different configurations
- Add email signature support for all sending operations (send, reply, forward)
- Improve attachment handling in forwarded messages
- Enhance own-address filtering with support for alias grouping
- Implement proper HTML formatting for forwarded message headers
- Add support for template-based emails in all sending operations
- Develop tools for group management (distribution lists)
- Create visualization tools for email threading and conversation flow

